{% extends 'base.html' %}

{% block title %}{{ _('Home') }} - See What AI Sees{% endblock %}

{% block content %}
<div class="text-center mb-5">
  <h1 class="display-5 fw-bold text-primary">{{ _('See What AI Sees') }}</h1>
  <p class="lead text-secondary">{{ _('Upload an image and let our smart captioning engine describe it with precision.') }}</p>
</div>

<div class="row g-4">
  <!-- Upload Section -->
  <div class="col-md-7">
    <div class="card p-4 shadow-sm">
      <h4 class="mb-3 text-primary">{{ _('Upload an Image') }}</h4>
   <form action="{{ url_for('upload_image') }}" method="post" enctype="multipart/form-data" id="captionForm">
        <div class="mb-3">
          <input type="file" name="image" accept="image/*" class="form-control" required lang="en">
          <small class="text-muted">{{ _('Supported formats: JPG, PNG. Max size: up to 15MB.') }}</small>
        </div>

        <img id="previewImage" class="img-fluid mt-3 border rounded" style="max-width:300px;">


<div class="mb-3">
  <label class="form-label text-primary">{{ _('Choose Model') }}</label>
  <select name="model_choice" class="form-control">
      <option value="base" {% if model_used == 'base' %}selected{% endif %}>Standard (BLIP Base)</option>
      <option value="large" {% if model_used == 'large' %}selected{% endif %}>Premium (BLIP Large)</option>

  </select>
</div>

        <div class="d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary">{{ _('Generate Caption') }}</button>
<a class="btn btn-outline-secondary" href="{{ url_for('dashboard_bp.reset_data') }}">{{ _('Reset') }}</a>

          <button type="button" class="btn btn-info text-white" onclick="loadSampleImage();">{{ _('Try Sample') }}</button>
        </div>

      <div id="loading" class="mt-4 text-center" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">{{ _('Generating caption, please wait...') }}</p>
      </div>

</form>

</div>

{% if image_url and caption %}
<div class="card text-center p-4 shadow-sm mt-4">
  <h4 class="mb-3 text-success">{{ _('Result') }}</h4>
  <img src="{{ image_url }}" alt="Uploaded Image" class="img-fluid mb-3 border rounded" style="max-width: 500px;">
  <h5>{{ _('Generated Caption:') }}</h5>
<p id="captionText" class="lead">{{ caption }}</p>

{% if translated_caption %}
   <button type="button" class="btn arabic-btn mt-2" onclick="showArabicTranslation()">
    ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
</button>


    <div id="arabic-translation" style="display: none; margin-top: 10px;">
        <h5 class="mt-3 text-primary">ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©:</h5>
        <p class="lead" style="font-weight: 500;">{{ translated_caption }}</p>
    </div>
{% endif %}



<p id="modelUsedText" class="text-muted">

  {{ _('Model Used:') }}
  {% if model_used|lower == 'large' or model_used|lower == 'premium' %}
      BLIP Large
  {% else %}
      BLIP Base
  {% endif %}
</p>
  <div class="d-flex flex-wrap justify-content-center gap-2">
    <button type="button" class="btn btn-outline-secondary" onclick="copyCaption()">üìã {{ _('Copy') }}</button>
    <button type="button" class="btn btn-warning text-dark" onclick="speakCaption()">üîä {{ _('Listen') }}</button>
    <button type="button" class="btn btn-danger" onclick="stopCaption()">‚èπÔ∏è {{ _('Stop') }}</button>
  </div>

  <!-- Auto-submitted analytics form to persist the result (session + Advanced) -->
  <form id="analyticsForm" method="POST" action="{{ url_for('dashboard_bp.generate_image') }}" style="display: none;">
    <input type="hidden" name="caption" value="{{ caption }}">
    <input type="hidden" name="language" value="{{ language }}">
  </form>
</div>
{% elif error %}
<div class="alert alert-danger mt-4">{{ error }}</div>
{% endif %}
</div>


  <!-- Chart Section -->
  <div class="col-md-5">
    <div class="card p-4 shadow-sm">
      <h5 class="mb-3 text-primary">{{ _('Caption Lengths Overview') }}</h5>
      <canvas id="homeCaptionChart" style="max-height: 300px;"></canvas>

    </div>
  </div>
</div>

<!-- How it works -->
<section class="mt-5" data-aos="fade-up">
  <h3 class="text-center mb-4 text-primary">{{ _('How It Works') }}</h3>
  <div class="row text-center">
    <div class="col-md-4">
      <i class="bi bi-upload fs-1 text-info"></i>
      <h5 class="mt-2">{{ _('Upload') }}</h5>
      <p>{{ _('Choose an image or try a sample to begin.') }}</p>
    </div>
    <div class="col-md-4">
      <i class="bi bi-cpu fs-1 text-success"></i>
      <h5 class="mt-2">{{ _('Analyze') }}</h5>
      <p>{{ _('Our AI model processes the image instantly.') }}</p>
    </div>
    <div class="col-md-4">
      <i class="bi bi-chat-left-text fs-1 text-warning"></i>
      <h5 class="mt-2">{{ _('Caption') }}</h5>
      <p>{{ _('Get a smart, human-like description in seconds.') }}</p>
    </div>
  </div>
</section>

<!-- Sample Result -->
<section class="mt-5" data-aos="zoom-in">
  <h3 class="text-center mb-4 text-primary">{{ _('Sample Result') }}</h3>
  <div class="row justify-content-center">
    <div class="col-md-4 text-center">
      <div class="p-2 rounded" style="background: linear-gradient(to right, #003366, #00BFFF); display: inline-block;">
        <img src="/static/uploads/sample.jpg" class="img-fluid rounded border" alt="Sample"
             style="border: 4px solid white;">
      </div>
      <p class="lead">{{ _('a rabbit running down the road in the countryside') }}</p>
    </div>
  </div>
</section>

<!-- About -->
<section class="mt-5" data-aos="fade-up">
  <h3 class="text-center mb-4 text-primary">{{ _('About This Project') }}</h3>
  <p class="text-center px-4 text-secondary">
    {{ _('This AI-powered web app transforms images into meaningful captions using deep learning. Designed for accessibility, education, and smart content generation.') }}
  </p>
</section>

<!-- Features -->
<section class="mt-5" data-aos="fade-up">
  <h3 class="text-center mb-4 text-primary">{{ _('Key Features') }}</h3>
  <div class="row text-center">
    <div class="col-md-3">
      <i class="bi bi-lightning fs-1 text-warning"></i>
      <h6>{{ _('Fast') }}</h6>
      <p>{{ _('Captions generated in seconds.') }}</p>
    </div>
    <div class="col-md-3">
      <i class="bi bi-wifi-off fs-1 text-danger"></i>
      <h6>{{ _('Offline Ready') }}</h6>
      <p>{{ _('Works without internet after setup.') }}</p>
    </div>
    <div class="col-md-3">
      <i class="bi bi-phone fs-1 text-success"></i>
      <h6>{{ _('Mobile Friendly') }}</h6>
      <p>{{ _('Responsive and intuitive interface.') }}</p>
    </div>
    <div class="col-md-3">
      <i class="bi bi-bullseye fs-1 text-info"></i>
      <h6>{{ _('Accurate') }}</h6>
      <p>{{ _('Captions reflect image content with precision.') }}</p>
    </div>
  </div>
</section>
<!-- Try Now -->
<section class="mt-5 text-center" data-aos="zoom-in">
  <h3 class="mb-3 text-primary">{{ _('Try It Now') }}</h3>
  <a href="#captionForm" class="btn btn-lg btn-primary">{{ _('Start Your AI Experience üëá') }}</a>
</section>


<!-- Scripts -->
<script type="text/javascript">
  const imageLabels = JSON.parse('{{ image_labels | tojson | safe }}') || [];
  const captionLengths = JSON.parse('{{ caption_lengths | tojson | safe }}') || [];

document.addEventListener("DOMContentLoaded", function () {
    const captionTextEl = document.getElementById('captionText');
    const analyticsForm = document.getElementById('analyticsForm');

    if (captionTextEl && analyticsForm) {
        const isNew = sessionStorage.getItem('newUpload');
        if (isNew === '1') {
            sessionStorage.setItem('newUpload', '0');
            analyticsForm.submit();
        }
    }
});



  // --- ŸÇŸÜÿßÿ© ÿßŸÑŸÖŸàÿØŸÑ ---
  const channel = new BroadcastChannel("modelChannel");

  document.addEventListener("DOMContentLoaded", function () {
    const isNew = sessionStorage.getItem('newUpload');
    const captionTextEl = document.getElementById('captionText'); // Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ÿπŸÜÿØ ŸÜÿ¨ÿßÿ≠ ÿßŸÑÿ™ŸàŸÑŸäÿØ

    if (isNew === '1' && captionTextEl) {
      setTimeout(() => {
        channel.postMessage({ action: "updateModel" });
        sessionStorage.setItem('newUpload', '0');
      }, 1000);
    }
  });

  document.getElementById('captionForm').addEventListener('submit', function () {
    document.getElementById('loading').style.display = 'block';
    sessionStorage.setItem('newUpload', '1');
  });

  function speakCaption() {
    const caption = document.getElementById("captionText");
    if (!caption) return;
    const utterance = new SpeechSynthesisUtterance(caption.textContent);
    utterance.lang = "en-US";
    utterance.rate = 1;
    speechSynthesis.speak(utterance);
  }

  function stopCaption() { speechSynthesis.cancel(); }

  function copyCaption() {
    const caption = document.getElementById("captionText");
    if (!caption) return;
    navigator.clipboard.writeText(caption.textContent);
  }

  function loadSampleImage() { window.location.href = "/static/uploads/sample.jpg"; }
</script>


<!-- ÿ≥ŸÉÿ±ÿ®ÿ™ ÿ±ÿ≥ŸÖ ÿßŸÑŸáŸàŸÖ (ÿßŸÑŸàÿ≠ŸäÿØ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®) -->
<script>
window.addEventListener("load", function () {
  const canvas = document.getElementById('homeCaptionChart');

  // ‚ú® ŸÑÿß ÿ™ÿ±ÿ≥ŸÖ ÿ•ÿ∞ÿß ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ©
  if (!canvas || !Array.isArray(imageLabels) || !Array.isArray(captionLengths)) return;
  if (imageLabels.length === 0 || captionLengths.length === 0) return;

  const ctx = canvas.getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: imageLabels,
      datasets: [{
        label: 'Caption Length (words)',
        data: captionLengths,
        backgroundColor: '#0078d4',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: false },
        legend: { display: false }
      },
     scales: {
    y: { beginAtZero: true },
    x: {
        ticks: {
            autoSkip: true,
            maxTicksLimit: 5,
            maxRotation: 0,
            minRotation: 0,
            font: { size: 11 },
            callback: function (value) {
                const label = this.getLabelForValue(value);
                return label.split('/').pop();
            }
        }
    }
}

    }
  });

  
});
</script>

<script>
window.addEventListener("load", function () {
    const modelText = document.getElementById("modelUsedText");
    if (modelText) modelText.style.visibility = "visible";
});
</script>


{% endblock %}


